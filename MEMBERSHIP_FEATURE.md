# 会员功能使用说明

## 功能概述

本项目新增了会员购买功能，用户可以通过区块链钱包（MetaMask）支付开通VIP会员，享受无限次植物健康检测等专属权益。

## 功能特性

### 会员权益
- ✅ **无限次植物健康检测** - VIP用户不受每月5次的检测限制
- ✅ **优先使用最新AI模型** - 优先体验最新的植物识别技术
- ✅ **专属会员标识** - 在个人中心显示VIP标识
- ✅ **7x24小时优先客服支持** - 优先获得技术支持

### 套餐选择
1. **月度会员** - 0.001 ETH / 30天
2. **季度会员** - 0.0025 ETH / 90天（省17%）
3. **年度会员** - 0.008 ETH / 365天（省33%）

## 使用流程

### 前端操作

1. **登录账号**
   - 用户必须先登录才能购买会员

2. **进入会员购买页面**
   - 在"我的"页面点击"立即开通会员"按钮
   - 弹出会员购买模态框

3. **选择套餐**
   - 在模态框中选择月度、季度或年度会员套餐
   - 查看会员权益和价格信息

4. **连接钱包并支付**
   - 点击"连接钱包并支付"按钮
   - 浏览器会提示连接MetaMask钱包
   - 确认钱包连接后，会自动发起支付交易
   - 在MetaMask中确认交易

5. **完成购买**
   - 交易确认后，后端自动升级用户为VIP
   - 会员状态即时更新

### 后端接口

#### 1. 获取会员状态
```http
GET /membership/status
Authorization: Bearer <token>
```

响应：
```json
{
  "is_vip": false,
  "monthly_detections": 3,
  "remaining_detections": 2
}
```

#### 2. 购买会员
```http
POST /membership/purchase
Authorization: Bearer <token>
Content-Type: application/json

{
  "transaction_hash": "0x1234567890abcdef...",
  "wallet_address": "0x742d35Cc6634C0532925a3b844Bc454e4438f44e",
  "plan": "monthly"
}
```

响应：
```json
{
  "success": true,
  "message": "恭喜！您已成功开通monthly会员",
  "is_vip": true
}
```

## 技术实现

### 前端技术
- **React Hooks** - 使用useState管理会员状态和模态框
- **Web3.js/MetaMask** - 使用window.ethereum API进行钱包连接和支付
- **Axios** - 调用后端API确认支付

### 后端技术
- **FastAPI** - RESTful API框架
- **Pydantic** - 数据验证
- **SQLAlchemy** - 数据库ORM

### 区块链集成
- 使用以太坊区块链进行支付
- 通过MetaMask钱包进行交易签名
- 交易哈希存储在后端用于验证

## 安全说明

### 当前实现（演示版本）
- 后端接收交易哈希后直接升级用户为VIP
- **不进行链上交易验证**

### 生产环境改进建议
1. **验证交易真实性**
   - 使用Web3.js或ethers.js验证交易是否存在于区块链
   - 验证交易接收地址是否正确
   - 验证交易金额是否符合套餐价格

2. **防止重复使用**
   - 将已使用的交易哈希存储在数据库
   - 检查交易哈希是否已被使用

3. **交易确认**
   - 等待交易被区块链确认（建议至少6个确认）
   - 监听交易状态变化

4. **错误处理**
   - 处理交易失败情况
   - 实现退款机制
   - 添加交易超时处理

## 环境要求

### 前端
- 浏览器需安装MetaMask插件
- 钱包需有足够的ETH余额（包括gas费）

### 后端
- Python 3.8+
- FastAPI
- SQLAlchemy
- MySQL数据库

## 测试指南

### 测试钱包支付
1. 安装MetaMask浏览器插件
2. 创建或导入测试钱包
3. 切换到测试网络（如Sepolia）
4. 获取测试ETH（从faucet）
5. 在应用中尝试购买会员

### 验证会员状态
1. 购买成功后，检查"我的"页面会员状态
2. 尝试进行植物检测，验证无限次检测功能
3. 查看个人中心的VIP标识

## 注意事项

1. **测试环境**
   - 建议先在以太坊测试网（Sepolia、Goerli）进行测试
   - 不要在主网使用真实资金测试

2. **Gas费用**
   - 实际支付金额 = 套餐价格 + Gas费
   - Gas费用根据网络拥堵情况动态变化

3. **交易延迟**
   - 区块链交易需要时间确认
   - 当前实现未等待交易确认，可能存在风险

4. **钱包安全**
   - 妥善保管私钥和助记词
   - 不要在不安全的环境使用钱包

## 未来改进方向

1. **支付网关优化**
   - 集成Layer 2解决方案降低gas费
   - 支持多种加密货币支付
   - 添加法币支付选项

2. **会员管理**
   - 添加会员到期时间
   - 实现自动续费功能
   - 提供会员优惠码

3. **用户体验**
   - 添加支付进度提示
   - 优化钱包连接流程
   - 提供详细的支付帮助文档

## 相关文件

- 前端：`/front/App.jsx`
- 后端：`/backend/main.py`
- 数据模型：`/backend/models.py`
- API模式：`/backend/schemas.py`

## 联系支持

如有问题，请联系开发团队或提交Issue。
